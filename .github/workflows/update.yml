name: Get Free Nodes
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  fetch_nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract Proxies Only
        run: |
          # 1. 下载原始完整配置文件
          curl -L -o full.yaml "https://raw.githubusercontent.com/anaer/Sub/main/clash.yaml"
          
          # 2. 使用 yq 提取 proxies 字段并重新生成 YAML
          # yq 会自动处理格式，确保输出只有 proxies: 及其下方内容
          # 如果没有 yq，Ubuntu runner 自带了，可以直接用
          yq '.proxies' full.yaml > nodes_list.yaml
          
          # 3. 构造 Mihomo 要求的规范格式 (必须有 proxies: 头部)
          echo "proxies:" > nodes.yaml
          cat nodes_list.yaml >> nodes.yaml
          
          # 4. 检查是否真的提取到了内容（防止后端下回来的是 HTML 报错页面）
          if [ $(stat -c%s "nodes.yaml") -lt 200 ]; then
            echo "提取失败，内容过短"
            exit 1
          fi

      - name: Git Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add nodes.yaml
          git commit -m "Update nodes $(date)" || echo "No changes"
          git push

      - name: Refresh jsDelivr
        run: curl -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/nodes.yaml"
