name: Get Free Nodes
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  fetch_nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Extract Proxies via Python
        run: |
          python - <<EOF
          import yaml
          import requests

          url = "https://raw.githubusercontent.com/anaer/Sub/main/clash.yaml"
          try:
              # 1. 下载文件
              r = requests.get(url, timeout=30)
              data = yaml.safe_load(r.text)

              # 2. 提取 proxies 部分
              if 'proxies' in data:
                  output = {'proxies': data['proxies']}
                  # 3. 保存为 nodes.yaml
                  with open('nodes.yaml', 'w', encoding='utf-8') as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False)
                  print("Successfully extracted proxies!")
              else:
                  print("Error: No 'proxies' field found in the source!")
                  exit(1)
          except Exception as e:
              print(f"Error: {e}")
              exit(1)
          EOF

      - name: Git Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add nodes.yaml
          git commit -m "Update nodes $(date)" || echo "No changes"
          git push

      - name: Refresh jsDelivr
        run: curl -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/nodes.yaml"
