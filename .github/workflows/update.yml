name: Get Free Nodes
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  fetch_nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install PyYAML requests

      - name: Extract Proxies
        run: |
          python - <<EOF
          import yaml
          import requests
          import sys

          urls = [
              "https://fastly.jsdelivr.net/gh/anaer/Sub@main/clash.yaml",
              "https://raw.githubusercontent.com/oslook/free-clash/main/clash.yaml"
          ]

          success = False
          for url in urls:
              try:
                  print(f"Trying to fetch: {url}")
                  r = requests.get(url, timeout=15)
                  # 使用 FullLoader 处理可能存在的 YAML 锚点
                  data = yaml.load(r.text, Loader=yaml.FullLoader)
                  
                  if data and isinstance(data, dict) and 'proxies' in data:
                      nodes = data['proxies']
                      if isinstance(nodes, list):
                          with open('nodes.yaml', 'w', encoding='utf-8') as f:
                              yaml.dump({'proxies': nodes}, f, allow_unicode=True, sort_keys=False)
                          print(f"Success! Found {len(nodes)} nodes.")
                          success = True
                          break
              except Exception as e:
                  print(f"Error on {url}: {e}")

          if not success:
              print("All sources failed or format invalid!")
              sys.exit(1)
          EOF

      - name: Git Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add nodes.yaml
          git commit -m "Update nodes $(date)" || echo "No changes"
          git push

      - name: Refresh jsDelivr
        run: curl -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/nodes.yaml"
