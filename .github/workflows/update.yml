name: Get Free Nodes
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  fetch_nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Direct Download and Format
        run: |
          # 1. 下载原始文件
          curl -L -o full_config.yaml "https://raw.githubusercontent.com/anaer/Sub/main/clash.yaml"
          
          # 2. 使用 yq 或 sed 提取 proxies 部分 (这里用 sed 简单粗暴但有效)
          # 我们只保留从 'proxies:' 开始到第一个 'proxy-groups:' 之前的内容
          sed -n '/^proxies:/,/^proxy-groups:/p' full_config.yaml | sed '$d' > nodes.yaml
          
          # 3. 检查 nodes.yaml 是否符合标准
          if ! grep -q "proxies:" nodes.yaml; then
            echo "提取失败，文件不规范"
            exit 1
          fi


      - name: Git Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add nodes.yaml
          git commit -m "Update nodes $(date)" || echo "No changes"
          git push

      - name: Refresh jsDelivr
        run: curl -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/nodes.yaml"
