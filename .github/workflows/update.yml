name: Get Free Nodes
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  fetch_nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download and Convert
        run: |
          # 1. 下载原始文件并保存为 temp.txt
          # 我们先拿这个源测试：它很稳
          curl -L -o temp.txt "https://raw.githubusercontent.com/anaer/Sub/main/clash.yaml"
          
          # 2. 调用后端进行转换。注意：我们把 temp.txt 传给后端
          # 使用 raw.githubusercontent.com 往往会被后端防火墙拦截，
          # 所以我们直接通过转换接口处理已经下载好的内容（或者直接用它的订阅链接）
          SUB_URL="https://raw.githubusercontent.com/anaer/Sub/main/clash.yaml"
          
          # 这里换一个更强力的公共后端：url.v1.mk
          curl -L -o nodes.yaml "https://subapi.zrfme.com/sub?target=clash&list=true&url=${SUB_URL}"
          
          # 3. 检查文件大小，如果小于 100 字节，说明转换失败，报错停止，不推送到仓库
          if [ $(stat -c%s "nodes.yaml") -lt 100 ]; then
            echo "Error: nodes.yaml is too small, check backend!"
            exit 1
          fi

      - name: Git Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add nodes.yaml
          git commit -m "Update nodes $(date)" || echo "No changes"
          git push

      - name: Refresh jsDelivr
        run: curl -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/nodes.yaml"
